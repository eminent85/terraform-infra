name: Create Ephemeral GKE Cluster

on:
  workflow_call:
    inputs:
      cluster_identifier:
        description: 'Unique identifier for the cluster (e.g., pr-123, commit-abc123)'
        required: true
        type: string
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.5.0'
      machine_type:
        description: 'GKE node machine type'
        required: false
        type: string
        default: 'e2-medium'
      min_nodes:
        description: 'Minimum number of nodes'
        required: false
        type: number
        default: 1
      max_nodes:
        description: 'Maximum number of nodes'
        required: false
        type: number
        default: 3
      region:
        description: 'GCP region'
        required: false
        type: string
        default: 'us-central1'
      zone:
        description: 'GCP zone'
        required: false
        type: string
        default: 'us-central1-a'
      enable_bastion:
        description: 'Create bastion host for debugging'
        required: false
        type: boolean
        default: false
      project_id:
        description: 'GCP project id'
        required: true
        type: string
    secrets:
      gcp_sa_key:
        description: 'gcp service account key to authenticate with gcloud api'
        required: true
    outputs:
      cluster_name:
        description: 'Name of the created GKE cluster'
        value: ${{ jobs.create-cluster.outputs.cluster_name }}
      cluster_endpoint:
        description: 'GKE cluster endpoint'
        value: ${{ jobs.create-cluster.outputs.cluster_endpoint }}
      cluster_location:
        description: 'GKE cluster location'
        value: ${{ jobs.create-cluster.outputs.cluster_location }}
      get_credentials_command:
        description: 'Command to get cluster credentials'
        value: ${{ jobs.create-cluster.outputs.get_credentials_command }}

jobs:
  create-cluster:
    name: Create Ephemeral Cluster
    runs-on: ubuntu-latest

    outputs:
      cluster_name: ${{ steps.terraform-output.outputs.cluster_name }}
      cluster_endpoint: ${{ steps.terraform-output.outputs.cluster_endpoint }}
      cluster_location: ${{ steps.terraform-output.outputs.cluster_location }}
      get_credentials_command: ${{ steps.terraform-output.outputs.get_credentials_command }}

    defaults:
      run:
        working-directory: environments/ephemeral

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4
        with:
          repository: eminent85/terraform-infra

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.gcp_sa_key}}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ inputs.project_id }}

      - name: Generate unique environment name
        id: env-name
        run: |
          # Sanitize identifier for GCP naming (lowercase, alphanumeric, hyphens)
          SANITIZED=$(echo "${{ inputs.cluster_identifier }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | cut -c1-40)
          ENV_NAME="ephemeral-${SANITIZED}"
          echo "env_name=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "Creating cluster: ${ENV_NAME}"

      - name: Create tfvars file from template
        run: |
          # Use envsubst to substitute variables in template
          export PROJECT_ID="${{ inputs.project_id }}"
          export REGION="${{ inputs.region }}"
          export ZONE="${{ inputs.zone }}"
          export ENVIRONMENT_NAME="${{ steps.env-name.outputs.env_name }}"
          export MACHINE_TYPE="${{ inputs.machine_type }}"
          export INITIAL_NODE_COUNT="${{ inputs.min_nodes }}"
          export MIN_NODE_COUNT="${{ inputs.min_nodes }}"
          export MAX_NODE_COUNT="${{ inputs.max_nodes }}"
          export CREATE_BASTION="${{ inputs.enable_bastion }}"
          export WORKFLOW_RUN_ID="${{ github.run_id }}"
          export SOURCE_REPO="${{ github.repository }}"

          envsubst < terraform.tfvars.tpl > terraform.tfvars

      - name: Terraform Init
        run: terraform init

      - name: Select or Create Terraform Workspace
        run: |
          WORKSPACE_NAME="${{ steps.env-name.outputs.env_name }}"
          echo "Using workspace: $WORKSPACE_NAME"

          # Try to select workspace, create if it doesn't exist
          if terraform workspace select "$WORKSPACE_NAME" 2>/dev/null; then
            echo "âœ“ Switched to existing workspace: $WORKSPACE_NAME"
            echo "âš ï¸  WARNING: Workspace already exists. This may indicate a previous cluster was not cleaned up."

            # Show what's in the state
            echo "Current resources in state:"
            terraform state list || echo "No resources found"
          else
            echo "Creating new workspace: $WORKSPACE_NAME"
            terraform workspace new "$WORKSPACE_NAME"
            echo "âœ“ Created new workspace: $WORKSPACE_NAME"
          fi

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan -no-color
        env:
          TF_VAR_project_id: ${{ inputs.project_id }}

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        env:
          TF_VAR_project_id: ${{ inputs.project_id }}

      - name: Extract Terraform Outputs
        id: terraform-output
        run: |
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          CLUSTER_LOCATION=$(terraform output -raw cluster_location)
          GET_CREDS_CMD=$(terraform output -raw get_credentials_command)

          echo "cluster_name=${CLUSTER_NAME}" >> $GITHUB_OUTPUT
          echo "cluster_location=${CLUSTER_LOCATION}" >> $GITHUB_OUTPUT
          echo "get_credentials_command=${GET_CREDS_CMD}" >> $GITHUB_OUTPUT

          # Store cluster endpoint (sensitive) in a secure way
          CLUSTER_ENDPOINT=$(terraform output -raw cluster_endpoint)
          echo "cluster_endpoint=${CLUSTER_ENDPOINT}" >> $GITHUB_OUTPUT

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ steps.terraform-output.outputs.cluster_name }} \
            --region ${{ inputs.region }} \
            --project ${{ inputs.project_id }}

      - name: Verify Cluster Access
        run: |
          kubectl cluster-info
          kubectl get nodes
          echo "âœ“ Cluster is ready and accessible"

      - name: Verify State in Remote Backend
        run: |
          echo "Verifying terraform state is stored in remote backend..."
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "âœ“ State contains $RESOURCE_COUNT resources"

          if [ "$RESOURCE_COUNT" -eq 0 ]; then
            echo "âš ï¸  WARNING: No resources in state after apply!"
            exit 1
          fi

          echo "State backend: GCS"
          echo "Workspace: ${{ steps.env-name.outputs.env_name }}"
          echo "âœ“ State successfully stored and verified"

      - name: Cluster Creation Summary
        run: |
          echo "### Ephemeral Cluster Created Successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`${{ steps.terraform-output.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Location: \`${{ steps.terraform-output.outputs.cluster_location }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Machine Type: \`${{ inputs.machine_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Nodes: ${{ inputs.min_nodes }}-${{ inputs.max_nodes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform State:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: GCS (\`eminent-dev-terraform-state\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Workspace: \`${{ steps.env-name.outputs.env_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- State Path: \`ephemeral-cluster/${{ steps.env-name.outputs.env_name }}/default.tfstate\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Get Credentials:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.terraform-output.outputs.get_credentials_command }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
