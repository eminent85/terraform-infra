name: Reusable Ephemeral Environment - Destroy

on:
  workflow_call:
    inputs:
      environment_name:
        description: 'Environment name to destroy (must match deployment name)'
        required: true
        type: string
      region:
        description: 'GCP region where the environment was deployed'
        required: false
        type: string
        default: 'us-central1'
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.5.0'
      skip_approval:
        description: 'Skip manual approval (automated cleanup)'
        required: false
        type: boolean
        default: false
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_SA_KEY:
        required: true

jobs:
  destroy-ephemeral:
    name: Destroy Ephemeral Environment
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./environments/ephemeral

    permissions:
      contents: read
      id-token: write
      actions: write

    steps:
      - name: Checkout Infrastructure Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/terraform-infra
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Download Terraform State
        id: download-state
        uses: actions/download-artifact@v4
        with:
          name: terraform-state-${{ inputs.environment_name }}
          path: ./environments/ephemeral
        continue-on-error: true

      - name: Check if State Exists
        id: check-state
        run: |
          if [ -f "terraform.tfstate" ]; then
            echo "state_exists=true" >> $GITHUB_OUTPUT
            echo "::notice::Terraform state found, proceeding with destroy"
          else
            echo "state_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::No Terraform state found. Will attempt to destroy based on environment name."
          fi

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy
        id: destroy
        run: |
          terraform destroy -auto-approve -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment_name=${{ inputs.environment_name }}" \
            -var="region=${{ inputs.region }}"
        continue-on-error: true

      - name: Manual Cleanup (if Terraform fails)
        if: steps.destroy.outcome == 'failure'
        run: |
          echo "::warning::Terraform destroy failed. Attempting manual cleanup..."

          # Try to delete GKE cluster
          CLUSTER_NAME="${{ inputs.environment_name }}-cluster"
          gcloud container clusters delete ${CLUSTER_NAME} \
            --region=${{ inputs.region }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet || echo "Cluster not found or already deleted"

          # Try to delete VPC network
          VPC_NAME="${{ inputs.environment_name }}-vpc"

          # Delete firewall rules first
          for rule in $(gcloud compute firewall-rules list --filter="network:${VPC_NAME}" --format="value(name)" --project=${{ secrets.GCP_PROJECT_ID }}); do
            gcloud compute firewall-rules delete ${rule} --project=${{ secrets.GCP_PROJECT_ID }} --quiet || true
          done

          # Delete subnets
          for subnet in $(gcloud compute networks subnets list --filter="network:${VPC_NAME}" --format="value(name,region)" --project=${{ secrets.GCP_PROJECT_ID }}); do
            IFS=$'\t' read -r subnet_name region <<< "$subnet"
            gcloud compute networks subnets delete ${subnet_name} --region=${region} --project=${{ secrets.GCP_PROJECT_ID }} --quiet || true
          done

          # Delete VPC
          gcloud compute networks delete ${VPC_NAME} --project=${{ secrets.GCP_PROJECT_ID }} --quiet || true

          echo "::notice::Manual cleanup completed"

      - name: Verify Destruction
        run: |
          echo "::notice::Environment '${{ inputs.environment_name }}' has been destroyed"
          echo "Destruction completed at: $(date)"

          # Verify cluster is gone
          CLUSTER_EXISTS=$(gcloud container clusters list \
            --filter="name=${{ inputs.environment_name }}-cluster" \
            --format="value(name)" \
            --project=${{ secrets.GCP_PROJECT_ID }} || echo "")

          if [ -z "$CLUSTER_EXISTS" ]; then
            echo "âœ… GKE cluster successfully deleted"
          else
            echo "âš ï¸ GKE cluster still exists"
          fi

      - name: Cleanup Artifacts
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const artifacts = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const envName = '${{ inputs.environment_name }}';
              const toDelete = artifacts.data.artifacts.filter(artifact =>
                artifact.name.includes(envName)
              );

              for (const artifact of toDelete) {
                console.log(`Deleting artifact: ${artifact.name}`);
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id,
                  });
                } catch (error) {
                  console.log(`Failed to delete ${artifact.name}: ${error.message}`);
                }
              }
            } catch (error) {
              console.log(`Artifact cleanup failed: ${error.message}`);
            }

      - name: Create Destruction Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ—‘ï¸ Ephemeral Environment Destroyed

          **Environment:** \`${{ inputs.environment_name }}\`
          **Destroyed At:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Status:** ${{ steps.destroy.outcome == 'success' && 'âœ… Success' || 'âš ï¸ Partial (manual cleanup performed)' }}

          All resources have been cleaned up and artifacts removed.
          EOF
