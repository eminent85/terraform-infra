name: Ephemeral Environment - Deploy

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Unique environment name (e.g., test-pr-123, test-commit-abc)'
        required: true
        type: string
      create_bastion:
        description: 'Create bastion host for debugging'
        required: false
        type: boolean
        default: false
      machine_type:
        description: 'GKE node machine type'
        required: false
        type: string
        default: 'e2-medium'
      max_node_count:
        description: 'Maximum number of nodes'
        required: false
        type: string
        default: '3'
      reason:
        description: 'Reason for deployment'
        required: false
        type: string

jobs:
  deploy-ephemeral:
    name: Deploy Ephemeral Environment
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./environments/ephemeral

    permissions:
      contents: read
      id-token: write

    outputs:
      cluster_name: ${{ steps.output.outputs.cluster_name }}
      cluster_region: ${{ steps.output.outputs.cluster_region }}
      environment_name: ${{ inputs.environment_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'
          terraform_wrapper: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false -out=tfplan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment_name=${{ inputs.environment_name }}" \
            -var="create_bastion=${{ inputs.create_bastion }}" \
            -var="machine_type=${{ inputs.machine_type }}" \
            -var="max_node_count=${{ inputs.max_node_count }}"

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve -input=false tfplan

      - name: Capture Terraform Outputs
        id: output
        run: |
          echo "cluster_name=$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT
          echo "cluster_region=$(terraform output -raw cluster_location)" >> $GITHUB_OUTPUT
          terraform output -json > terraform-outputs.json

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ inputs.environment_name }}
          path: environments/ephemeral/terraform-outputs.json
          retention-days: 7

      - name: Upload Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-${{ inputs.environment_name }}
          path: environments/ephemeral/terraform.tfstate
          retention-days: 7

      - name: Display Quick Start Commands
        run: |
          echo "::notice::Ephemeral environment '${{ inputs.environment_name }}' deployed successfully!"
          echo ""
          echo "### Get Cluster Credentials"
          echo "gcloud container clusters get-credentials ${{ inputs.environment_name }}-cluster --region ${{ secrets.GCP_REGION || 'us-central1' }} --project ${{ secrets.GCP_PROJECT_ID }}"
          echo ""
          echo "### Verify Access"
          echo "kubectl get nodes"

      - name: Comment on PR (if triggered from PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### üöÄ Ephemeral Environment Deployed

            **Environment Name:** \`${{ inputs.environment_name }}\`
            **Cluster Name:** \`${{ steps.output.outputs.cluster_name }}\`
            **Region:** \`${{ steps.output.outputs.cluster_region }}\`

            #### Get Credentials
            \`\`\`bash
            gcloud container clusters get-credentials ${{ steps.output.outputs.cluster_name }} --region ${{ steps.output.outputs.cluster_region }} --project ${{ secrets.GCP_PROJECT_ID }}
            \`\`\`

            #### Verify Access
            \`\`\`bash
            kubectl get nodes
            \`\`\`

            **‚ö†Ô∏è Remember to destroy this environment when done to avoid ongoing costs!**
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
