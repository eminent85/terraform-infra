name: Ephemeral Environment - Destroy

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Environment name to destroy (must match deployment name)'
        required: true
        type: string
      skip_approval:
        description: 'Skip manual approval (use with caution)'
        required: false
        type: boolean
        default: false
      reason:
        description: 'Reason for destruction'
        required: false
        type: string

jobs:
  destroy-plan:
    name: Plan Destruction
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./environments/ephemeral

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: terraform-state-${{ inputs.environment_name }}
          path: ./environments/ephemeral
        continue-on-error: true

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy Plan
        run: |
          terraform plan -destroy -no-color -input=false -out=destroy-plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment_name=${{ inputs.environment_name }}"

      - name: Upload Destroy Plan
        uses: actions/upload-artifact@v4
        with:
          name: destroy-plan-${{ inputs.environment_name }}
          path: environments/ephemeral/destroy-plan
          retention-days: 2

  destroy-approval:
    name: Approve Destruction
    runs-on: ubuntu-latest
    needs: destroy-plan
    if: ${{ !inputs.skip_approval }}
    environment:
      name: ephemeral-destroy-approval
      url: https://console.cloud.google.com/home/dashboard?project=${{ secrets.GCP_PROJECT_ID }}

    steps:
      - name: Manual Approval Required
        run: |
          echo "::notice::Manual approval received for destroying environment '${{ inputs.environment_name }}'"
          echo "Proceeding with destruction..."

  destroy:
    name: Destroy Environment
    runs-on: ubuntu-latest
    needs: [destroy-plan, destroy-approval]
    if: always() && (needs.destroy-approval.result == 'success' || (needs.destroy-approval.result == 'skipped' && inputs.skip_approval))

    defaults:
      run:
        working-directory: ./environments/ephemeral

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: terraform-state-${{ inputs.environment_name }}
          path: ./environments/ephemeral
        continue-on-error: true

      - name: Terraform Init
        run: terraform init

      - name: Download Destroy Plan
        uses: actions/download-artifact@v4
        with:
          name: destroy-plan-${{ inputs.environment_name }}
          path: ./environments/ephemeral

      - name: Terraform Destroy
        run: terraform apply -auto-approve destroy-plan

      - name: Verify Destruction
        run: |
          echo "::notice::Environment '${{ inputs.environment_name }}' has been destroyed successfully"
          echo "Destruction completed at: $(date)"

      - name: Cleanup Artifacts
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const envName = '${{ inputs.environment_name }}';
            const toDelete = artifacts.data.artifacts.filter(artifact =>
              artifact.name.includes(envName)
            );

            for (const artifact of toDelete) {
              console.log(`Deleting artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }

      - name: Comment on PR (if available)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### üóëÔ∏è Ephemeral Environment Destroyed

            **Environment Name:** \`${{ inputs.environment_name }}\`
            **Destroyed At:** ${new Date().toISOString()}
            ${inputs.reason ? `**Reason:** ${inputs.reason}` : ''}

            All resources have been cleaned up.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
